// Prisma схема для школьного портала

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Пользователь системы
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("STUDENT") // ADMIN, TEACHER, STUDENT, PARENT
  firstName String
  lastName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  student   Student?
  teacher   Teacher?
  parent    Parent?
  notifications Notification[]
  activityLogs ActivityLog[]
  sentMessages Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")

  @@map("users")
}

// Класс
model Class {
  id          String   @id @default(uuid())
  name        String   // Например: "10А", "11Б"
  grade       Int      // Класс (10, 11)
  description String?
  classTeacherId String? @unique // ID классного руководителя
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  students   Student[]
  schedules  Schedule[]
  classTeacher Teacher? @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  homeworks  Homework[]

  @@unique([name, grade])
  @@map("classes")
}

// Ученик
model Student {
  id        String   @id @default(uuid())
  userId    String   @unique
  classId   String
  studentNumber String? // Номер в журнале
  birthDate DateTime?
  address   String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  class     Class    @relation(fields: [classId], references: [id])
  grades    Grade[]
  schedules Schedule[] @relation("StudentSchedule")
  parents   Parent[]
  attendances Attendance[]
  homeworks Homework[]
  homeworkCompletions HomeworkCompletion[]

  @@map("students")
}

// Учитель
model Teacher {
  id          String   @id @default(uuid())
  userId      String   @unique
  employeeNumber String?
  specialization String?   // Специализация (математика, физика и т.д.)
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects    Subject[]
  schedules   Schedule[]
  grades      Grade[]
  classTeacher Class?  @relation("ClassTeacher")
  homeworks   Homework[]

  @@map("teachers")
}

// Предмет
model Subject {
  id          String   @id @default(uuid())
  name        String   // Математика, Физика и т.д.
  description String?
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  grades      Grade[]
  schedules   Schedule[]
  homeworks   Homework[]

  @@map("subjects")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // grade_added, grade_updated, profile_created, etc.
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String   // create, update, delete
  entity    String   // user, class, subject, grade, etc.
  entityId  String?
  details   String?  // JSON string with details
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
}

// Оценка
model Grade {
  id          String   @id @default(uuid())
  studentId   String
  subjectId   String
  teacherId   String
  value       Int      // Оценка (2-5)
  date        DateTime @default(now())
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject     Subject  @relation(fields: [subjectId], references: [id])
  teacher     Teacher  @relation(fields: [teacherId], references: [id])

  @@map("grades")
}

// Расписание
model Schedule {
  id          String   @id @default(uuid())
  classId     String
  subjectId  String
  teacherId   String
  dayOfWeek   Int      // 1-7 (понедельник-воскресенье)
  lessonNumber Int     // Номер урока (1, 2, 3...)
  room        String?  // Кабинет
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  class       Class    @relation(fields: [classId], references: [id])
  subject     Subject  @relation(fields: [subjectId], references: [id])
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  students    Student[] @relation("StudentSchedule")
  attendances Attendance[]

  @@unique([classId, dayOfWeek, lessonNumber])
  @@map("schedules")
}

// Родитель
model Parent {
  id        String   @id @default(uuid())
  userId    String   @unique
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  students  Student[]

  @@map("parents")
}

// Домашнее задание
model Homework {
  id          String   @id @default(uuid())
  subjectId   String
  teacherId   String
  studentId   String?
  classId     String?  // Если задание для всего класса
  title       String
  description String
  dueDate     DateTime // Дедлайн
  completed   Boolean  @default(false) // Для индивидуальных заданий
  completedAt DateTime?
  attachments String?  // JSON строка с прикрепленными файлами (URLs или пути)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  subject     Subject  @relation(fields: [subjectId], references: [id])
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  student     Student? @relation(fields: [studentId], references: [id])
  class       Class?   @relation(fields: [classId], references: [id])
  completions HomeworkCompletion[] // Записи о выполнении задания студентами

  @@map("homeworks")
}

// Выполнение домашнего задания студентом
model HomeworkCompletion {
  id          String   @id @default(uuid())
  homeworkId  String
  studentId   String
  completedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  // Связи
  homework    Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, studentId])
  @@map("homework_completions")
}

// Посещаемость
model Attendance {
  id          String   @id @default(uuid())
  studentId   String
  scheduleId  String
  date        DateTime @default(now())
  status      String   // present, absent, late, excused
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([studentId, scheduleId, date])
  @@map("attendances")
}

// Сообщение
model Message {
  id        String   @id @default(uuid())
  senderId  String
  receiverId String
  subject   String?
  content   String
  read      Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

